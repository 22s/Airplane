From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Paul Sauve <paul@technove.co>
Date: Sun, 13 Dec 2020 17:52:35 -0600
Subject: [PATCH] Reduce projectile chunk loading


diff --git a/src/main/java/net/minecraft/server/EntityProjectile.java b/src/main/java/net/minecraft/server/EntityProjectile.java
index 53a8ea7d1eff84abe6c49464d556aa2788a6abcb..e4e62e081e1c18627c5004a7e80f6e227f0bc5ae 100644
--- a/src/main/java/net/minecraft/server/EntityProjectile.java
+++ b/src/main/java/net/minecraft/server/EntityProjectile.java
@@ -85,6 +85,33 @@ public abstract class EntityProjectile extends IProjectile {
         this.setPosition(d0, d1, d2);
     }
 
+    private static int loadedThisTick = 0;
+    private static int loadedTick;
+
+    private int buffered = 0;
+
+    // AirplaneL start
+    @Override
+    public void setPosition(double d0, double d1, double d2) {
+        if (loadedTick != MinecraftServer.currentTick) {
+            loadedTick = MinecraftServer.currentTick;
+            loadedThisTick = 0;
+        }
+        boolean isLoaded = this.world.isChunkLoaded(MathHelper.floor(d0) >> 4, MathHelper.floor(d2) >> 4);
+        if (!isLoaded) {
+            if (loadedThisTick > 10) { // AirplaneL todo config
+                if (buffered++ > 20) {
+                    this.die();
+                }
+                return;
+            }
+            loadedTick++;
+        }
+        buffered = 0;
+        super.setPosition(d0, d1, d2);
+    }
+    // AirplaneL end
+
     protected float k() {
         return 0.03F;
     }
